% =================================================
% Document class
% =================================================
% Model:
% - Split markdown is authoritative structure
% - Pandoc translates headings -> LaTeX sections
% - LaTeX styles only (no manual bookmarks, no addcontentsline hacks)
%
% IMPORTANT:
% - Use a class that actually supports \chapter.
%   Pandoc maps top-level headings (#) to \chapter by default (unless you force otherwise).
%   Your previous 'report' class will not behave consistently for that.
\documentclass[
  a4paper,
  $fontsize$
]{book}

% =================================================
% Core packages
% =================================================
\usepackage{graphicx}
\usepackage{geometry}
\usepackage{setspace}
\usepackage{hyperref}
\usepackage{bookmark}
\usepackage{tocloft}
\usepackage{fancyhdr}
\usepackage{emptypage}
\usepackage{calc}
\usepackage{eso-pic}

% =================================================
% Page geometry & line spacing
% =================================================
\geometry{
  margin=25mm
}
\setstretch{$linestretch$}

% =================================================
% Global image sizing (content images)
% =================================================
\setkeys{Gin}{width=0.85\linewidth, keepaspectratio}

% =================================================
% Hyperlink appearance
% =================================================
\hypersetup{
  hidelinks,
  bookmarksopen=true,
  bookmarksnumbered=true
}

% =================================================
% Pandoc tables support
% =================================================
\usepackage{longtable}
\usepackage{booktabs}
\usepackage{array}

% =================================================
% Subtitle support (robust)
% =================================================
\makeatletter
\providecommand{\subtitle}[1]{\gdef\@subtitle{#1}}
\providecommand{\@subtitle}{} % safe default

\renewcommand{\maketitle}{%
  \begin{titlepage}
    \centering
    {\huge\bfseries \@title \par}
    \vspace{1em}
    \ifx\@subtitle\@empty\else
      {\Large \@subtitle \par}
      \vspace{2em}
    \fi
    \ifx\@author\@empty\else
      {\large \@author \par}
    \fi
    \vfill
    \ifx\@date\@empty\else
      {\large \@date \par}
    \fi
  \end{titlepage}
}
\makeatother

% =================================================
% Draft watermark (optional)
% =================================================
$if(draft)$
\usepackage{draftwatermark}
\SetWatermarkText{DRAFT}
\SetWatermarkScale{1}
\SetWatermarkColor[gray]{0.9}
$endif$

% =================================================
% Header / footer configuration
% =================================================
\pagestyle{fancy}
\fancyhf{}
\fancyfoot[C]{\thepage}
\renewcommand{\headrulewidth}{0pt}

% =================================================
% Pandoc compatibility: tight lists
% =================================================
\providecommand{\tightlist}{%
  \setlength{\itemsep}{0pt}%
  \setlength{\parskip}{0pt}%
}

% =================================================
% Pandoc compatibility: code blocks + highlighting
% =================================================
\usepackage{color}
\usepackage{framed}
\usepackage{fancyvrb}

\definecolor{shadecolor}{RGB}{245,245,245}

\newenvironment{Shaded}{%
  \begin{snugshade}%
}{%
  \end{snugshade}%
}

\DefineVerbatimEnvironment{Highlighting}{Verbatim}{%
  commandchars=\\\{\}%
}

% Pandoc syntax highlighting token definitions
\newcommand{\AlertTok}[1]{\textcolor{red}{#1}}
\newcommand{\AnnotationTok}[1]{\textcolor{gray}{#1}}
\newcommand{\AttributeTok}[1]{#1}
\newcommand{\BaseNTok}[1]{#1}
\newcommand{\BuiltInTok}[1]{#1}
\newcommand{\CharTok}[1]{#1}
\newcommand{\CommentTok}[1]{\textcolor{gray}{#1}}
\newcommand{\ConstantTok}[1]{#1}
\newcommand{\ControlFlowTok}[1]{#1}
\newcommand{\DataTypeTok}[1]{#1}
\newcommand{\DecValTok}[1]{#1}
\newcommand{\DocumentationTok}[1]{#1}
\newcommand{\ErrorTok}[1]{\textcolor{red}{#1}}
\newcommand{\ExtensionTok}[1]{#1}
\newcommand{\FloatTok}[1]{#1}
\newcommand{\FunctionTok}[1]{#1}
\newcommand{\ImportTok}[1]{#1}
\newcommand{\InformationTok}[1]{#1}
\newcommand{\KeywordTok}[1]{\textbf{#1}}
\newcommand{\NormalTok}[1]{#1}
\newcommand{\OperatorTok}[1]{#1}
\newcommand{\OtherTok}[1]{#1}
\newcommand{\PreprocessorTok}[1]{#1}
\newcommand{\RegionMarkerTok}[1]{#1}
\newcommand{\SpecialCharTok}[1]{#1}
\newcommand{\SpecialStringTok}[1]{#1}
\newcommand{\StringTok}[1]{#1}
\newcommand{\VariableTok}[1]{#1}
\newcommand{\VerbatimStringTok}[1]{#1}
\newcommand{\WarningTok}[1]{\textcolor{red}{#1}}

% =================================================
% Pandoc compatibility: allow 'none' as counter value
% =================================================
\makeatletter
\@ifundefined{c@none}{\newcounter{none}}{}
\makeatother

% =================================================
% Pandoc >= 3.x compatibility
% =================================================
\providecommand{\pandocbounded}[1]{#1}

% =================================================
% Matter controls (book provides these, but keep explicit wrappers)
% =================================================
% We keep them so your injected control files can call \frontmatter/\mainmatter
% even if you later swap class options.
\makeatletter
\providecommand{\frontmatter}{%
  \cleardoublepage%
  \pagenumbering{roman}%
}
\providecommand{\mainmatter}{%
  \cleardoublepage%
  \pagenumbering{arabic}%
}
\providecommand{\backmatter}{%
  \cleardoublepage%
}
\makeatother

% =================================================
% Heading + numbering model
% =================================================
% Model alignment:
% - #  -> \chapter  (Section in your book)
% - ## -> \section  (Chapter in your book)
% - ### -> \subsection
\setcounter{secnumdepth}{2}
\setcounter{tocdepth}{2}

% =================================================
% Chapter styling
% =================================================
% Keep chapters clean, but do not destroy LaTeX semantics.
% Do NOT inject bookmarks manually here.
\makeatletter
\renewcommand{\chaptername}{}
\def\@makechapterhead#1{%
  \vspace*{20pt}%
  {\parindent 0pt \raggedright
    \normalfont\Huge\bfseries
    \ifnum \c@chapter>0
      \thechapter\quad
    \fi
    #1\par\nobreak
    \vspace{12pt}%
  }%
}
\def\@makeschapterhead#1{%
  \vspace*{20pt}%
  {\parindent 0pt \raggedright
    \normalfont\Huge\bfseries
    #1\par\nobreak
    \vspace{12pt}%
  }%
}
\makeatother

% =================================================
% Section / subsection styling (chapters should remain the top)
% =================================================
% Your previous template made \section bigger than \chapter,
% which breaks the reader's mental model.
\makeatletter
\renewcommand\section{\@startsection{section}{1}{\z@}%
  {-3.0ex \@plus -1ex \@minus -.2ex}%
  {1.4ex \@plus .2ex}%
  {\normalfont\Large\bfseries}}
\renewcommand\subsection{\@startsection{subsection}{2}{\z@}%
  {-2.5ex\@plus -1ex \@minus -.2ex}%
  {1.0ex \@plus .2ex}%
  {\normalfont\large\bfseries}}
\makeatother

% =================================================
% TOC styling
% =================================================
\renewcommand{\cfttoctitlefont}{\Huge\bfseries}
\renewcommand{\cftaftertoctitle}{\hfill}

\renewcommand{\cftchapfont}{\bfseries}
\renewcommand{\cftchappagefont}{\bfseries}
\setlength{\cftchapindent}{0pt}
\setlength{\cftchapnumwidth}{3.0em}

\renewcommand{\cftsecfont}{\normalfont}
\renewcommand{\cftsecpagefont}{\normalfont}
\setlength{\cftsecindent}{1.8em}
\setlength{\cftsecnumwidth}{3.6em}

\renewcommand{\cftsubsecfont}{\normalfont}
\renewcommand{\cftsubsecpagefont}{\normalfont}
\setlength{\cftsubsecindent}{3.6em}
\setlength{\cftsubsecnumwidth}{4.2em}

% =================================================
% Document starts here
% =================================================
\begin{document}

% Covers and title pages should not carry headers/footers or numbers
\pagestyle{empty}
\pagenumbering{gobble}

% -------------------------------------------------
% Front cover (centred, aspect-safe)
% -------------------------------------------------
$if(cover_front)$
\clearpage
\thispagestyle{empty}
\AddToShipoutPictureBG*{%
  \AtPageCenter{%
    \makebox(0,0){%
      \includegraphics[
        width=\paperwidth,
        height=\paperheight,
        keepaspectratio
      ]{$cover_front$}%
    }%
  }%
}
\mbox{}
\clearpage
\ClearShipoutPictureBG
$endif$

% -------------------------------------------------
% Title page
% -------------------------------------------------
$if(title)$
\title{$title$}
$if(subtitle)$
\subtitle{$subtitle$}
$endif$
$if(author)$
\author{$author$}
$endif$
$if(date)$
\date{$date$}
$endif$
\maketitle
\clearpage
$endif$

% -------------------------------------------------
% Copyright page
% -------------------------------------------------
$if(copyright)$
\thispagestyle{empty}
\vspace*{\fill}
\begin{center}
$copyright$
\end{center}
\vspace*{\fill}
\clearpage
$endif$

% -------------------------------------------------
% Body
% -------------------------------------------------
% Structure is injected via control files produced by the split:
% - _front_control.md contains \frontmatter
% - 03_toc/00_section.md contains \cleardoublepage \tableofcontents \cleardoublepage
% - 04_mainmatter/00_section.md contains \mainmatter
$body$

% -------------------------------------------------
% Back cover (centred, aspect-safe)
% -------------------------------------------------
$if(cover_back)$
\clearpage
\thispagestyle{empty}
\AddToShipoutPictureBG*{%
  \AtPageCenter{%
    \makebox(0,0){%
      \includegraphics[
        width=\paperwidth,
        height=\paperheight,
        keepaspectratio
      ]{$cover_back$}%
    }%
  }%
}
\mbox{}
\clearpage
\ClearShipoutPictureBG
$endif$

\end{document}
